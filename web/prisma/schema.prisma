generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL_UNPOOLED") // User verified this var has no -pooler
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model User {
  id        String      @id @default(cuid())
  email     String      @unique
  password  String
  name      String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  isActive  Boolean     @default(true)
  role      Role        @default(USER)
  username  String?     @unique
  devices   Device[]
  media     MediaItem[]
  playlists Playlist[]
  schedules Schedule[]
}

model Device {
  id                   String      @id @default(cuid())
  name                 String?
  token                String      @unique @default(cuid())
  status               String      @default("unpaired")
  lastSeenAt           DateTime?
  userId               String?
  activePlaylistId     String?
  pairingCode          String?     @unique
  pairingCodeExpiresAt DateTime?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  defaultPlaylistId    String?
  scheduleId           String?
  playingPlaylistId    String?     // The playlist currently playing on the device
  currentContentName   String?
  previewImageUrl      String?
  previewCapturedAt    DateTime?
  activePlaylist       Playlist?   @relation(fields: [activePlaylistId], references: [id])
  defaultPlaylist      Playlist?   @relation("DefaultPlaylist", fields: [defaultPlaylistId], references: [id])
  playingPlaylist      Playlist?   @relation("PlayingPlaylist", fields: [playingPlaylistId], references: [id])
  schedule             Schedule?   @relation(fields: [scheduleId], references: [id])
  user                 User?       @relation(fields: [userId], references: [id])
  logs                 DeviceLog[]
}

model Schedule {
  id        String         @id @default(cuid())
  name      String
  userId    String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  devices   Device[]
  user      User           @relation(fields: [userId], references: [id])
  items     ScheduleItem[]
}

model ScheduleItem {
  id         String   @id @default(cuid())
  dayOfWeek  Int
  startTime  String
  endTime    String
  playlistId String
  scheduleId String
  playlist   Playlist @relation(fields: [playlistId], references: [id])
  schedule   Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
}

model DeviceLog {
  id        String   @id @default(cuid())
  level     String
  message   String
  deviceId  String
  createdAt DateTime @default(now())
  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId])
}

model MediaItem {
  id              String         @id @default(cuid())
  name            String
  type            String
  url             String
  filename        String?
  duration        Int            @default(10)
  userId          String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  fps             Float?
  height          Int?
  width           Int?
  size            Int            @default(0)
  cacheForOffline Boolean        @default(false)
  user            User           @relation(fields: [userId], references: [id])
  playlistItems   PlaylistItem[]
}

model Playlist {
  id                String         @id @default(cuid())
  name              String
  userId            String
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  orientation       String         @default("landscape")
  type              String         @default("media")
  devices           Device[]
  defaultForDevices Device[]       @relation("DefaultPlaylist")
  playingForDevices Device[]       @relation("PlayingPlaylist")
  user              User           @relation(fields: [userId], references: [id])
  items             PlaylistItem[]
  scheduleItems     ScheduleItem[]
}

model PlaylistItem {
  id          String    @id @default(cuid())
  order       Int
  playlistId  String
  mediaItemId String
  duration    Int       @default(10)
  mediaItem   MediaItem @relation(fields: [mediaItemId], references: [id])
  playlist    Playlist  @relation(fields: [playlistId], references: [id], onDelete: Cascade)
}

model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  USER
  ADMIN
}
